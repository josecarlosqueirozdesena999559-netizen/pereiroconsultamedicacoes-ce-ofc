CONFIGURA√á√ÉO COMPLETA DO SISTEMA UBS PEREIRO - BANCO DE DADOS SUPABASE
==========================================================================

Este documento cont√©m todas as configura√ß√µes necess√°rias para replicar o sistema em outro banco de dados Supabase.

1. CRIA√á√ÉO DAS TABELAS
======================

-- Enum para tipos de usu√°rio
CREATE TYPE public.user_role AS ENUM ('admin', 'responsavel');

-- Tabela de usu√°rios
CREATE TABLE public.usuarios (
    id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    email TEXT NOT NULL UNIQUE,
    senha TEXT NOT NULL,
    nome TEXT NOT NULL,
    tipo user_role NOT NULL DEFAULT 'responsavel',
    criado_em TIMESTAMP WITHOUT TIME ZONE DEFAULT now()
);

-- Tabela de postos/UBS
CREATE TABLE public.postos (
    id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    nome TEXT NOT NULL,
    localidade TEXT NOT NULL,
    horario_funcionamento TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'fechado',
    responsavel_id UUID,
    atualizado_em TIMESTAMP WITHOUT TIME ZONE DEFAULT now()
);

-- Tabela de relacionamento usu√°rio-posto (muitos para muitos)
CREATE TABLE public.usuario_posto (
    user_id UUID NOT NULL,
    posto_id UUID NOT NULL,
    PRIMARY KEY (user_id, posto_id)
);

-- Tabela de arquivos PDF
CREATE TABLE public.arquivos_pdf (
    id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
    url TEXT NOT NULL,
    posto_id UUID,
    data_upload TIMESTAMP WITHOUT TIME ZONE DEFAULT now()
);

2. FUN√á√ïES DO BANCO DE DADOS
============================

-- Fun√ß√£o de login
CREATE OR REPLACE FUNCTION public.fn_login(p_email text, p_senha text)
RETURNS TABLE(id uuid, email text, nome text, tipo text)
LANGUAGE plpgsql
STABLE SECURITY DEFINER
SET search_path TO 'public'
AS $function$
BEGIN
  RETURN QUERY
  SELECT usuarios.id, usuarios.email, usuarios.nome, usuarios.tipo::text
  FROM public.usuarios
  WHERE usuarios.email = p_email
    AND usuarios.senha = crypt(p_senha, usuarios.senha);
END;
$function$;

-- Fun√ß√£o para atualizar updated_at automaticamente
CREATE OR REPLACE FUNCTION public.handle_updated_at()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = 'public'
AS $function$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$function$;

-- Trigger para atualizar automaticamente o campo atualizado_em
CREATE TRIGGER update_postos_updated_at
    BEFORE UPDATE ON public.postos
    FOR EACH ROW
    EXECUTE FUNCTION public.handle_updated_at();

3. POL√çTICAS RLS (ROW LEVEL SECURITY)
=====================================

-- Habilitar RLS em todas as tabelas
ALTER TABLE public.usuarios ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.postos ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.usuario_posto ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.arquivos_pdf ENABLE ROW LEVEL SECURITY;

-- Pol√≠ticas para tabela usuarios
CREATE POLICY "Usuarios: Permitir todas opera√ß√µes"
ON public.usuarios
FOR ALL
USING (true)
WITH CHECK (true);

-- Pol√≠ticas para tabela postos
CREATE POLICY "Postos: Permitir todas opera√ß√µes"
ON public.postos
FOR ALL
USING (true)
WITH CHECK (true);

-- Pol√≠ticas para tabela usuario_posto
CREATE POLICY "Usuario_posto: Permitir todas opera√ß√µes"
ON public.usuario_posto
FOR ALL
USING (true)
WITH CHECK (true);

-- Pol√≠ticas para tabela arquivos_pdf
CREATE POLICY "Arquivos_pdf: Permitir todas opera√ß√µes"
ON public.arquivos_pdf
FOR ALL
USING (true)
WITH CHECK (true);

4. CONFIGURA√á√ÉO DO STORAGE (BUCKET)
===================================

-- Criar bucket para medica√ß√µes
INSERT INTO storage.buckets (id, name, public) 
VALUES ('medicacoes_ubs', 'medicacoes_ubs', true);

-- Pol√≠ticas do Storage
CREATE POLICY "Permitir visualiza√ß√£o p√∫blica dos arquivos"
ON storage.objects
FOR SELECT
USING (bucket_id = 'medicacoes_ubs');

CREATE POLICY "Permitir upload de arquivos"
ON storage.objects
FOR INSERT
WITH CHECK (bucket_id = 'medicacoes_ubs');

CREATE POLICY "Permitir atualiza√ß√£o de arquivos"
ON storage.objects
FOR UPDATE
USING (bucket_id = 'medicacoes_ubs');

CREATE POLICY "Permitir exclus√£o de arquivos"
ON storage.objects
FOR DELETE
USING (bucket_id = 'medicacoes_ubs');

5. DADOS INICIAIS (OPCIONAL)
============================

-- Inserir usu√°rio administrador padr√£o
INSERT INTO public.usuarios (email, senha, nome, tipo) 
VALUES (
    'admin@pereiro.ce.gov.br', 
    crypt('admin123', gen_salt('bf')), 
    'Administrador do Sistema', 
    'admin'
);

-- Inserir alguns postos de exemplo
INSERT INTO public.postos (nome, localidade, horario_funcionamento, status) VALUES
('UBS Centro', 'Centro', '07:00 - 17:00', 'aberto'),
('UBS S√£o Jos√©', 'S√£o Jos√©', '07:00 - 17:00', 'fechado'),
('UBS Vila Nova', 'Vila Nova', '07:00 - 17:00', 'aberto');

6. CONFIGURA√á√ïES ADICIONAIS
===========================

-- Habilitar extens√£o para criptografia de senhas
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- Configurar timezone (opcional)
SET timezone = 'America/Fortaleza';

7. VERIFICA√á√ïES DE SEGURAN√áA
============================

-- Verificar se RLS est√° habilitado em todas as tabelas
SELECT schemaname, tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' AND rowsecurity = true;

-- Verificar pol√≠ticas criadas
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual, with_check
FROM pg_policies 
WHERE schemaname = 'public';

8. OBSERVA√á√ïES IMPORTANTES
=========================

1. Altere as senhas padr√£o antes de usar em produ√ß√£o
2. Configure as vari√°veis de ambiente no seu projeto:
   - SUPABASE_URL: sua URL do Supabase
   - SUPABASE_ANON_KEY: sua chave an√¥nima do Supabase
3. As pol√≠ticas RLS est√£o configuradas como permissivas (true) para simplicidade
4. Em produ√ß√£o, considere implementar pol√≠ticas mais restritivas baseadas em autentica√ß√£o
5. O bucket de storage est√° configurado como p√∫blico para facilitar o acesso aos PDFs
6. Teste todas as funcionalidades ap√≥s a configura√ß√£o

9. COMANDOS DE VERIFICA√á√ÉO
=========================

-- Verificar se as tabelas foram criadas
SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';

-- Verificar se as fun√ß√µes foram criadas
SELECT routine_name FROM information_schema.routines WHERE routine_schema = 'public';

-- Verificar se o bucket foi criado
SELECT * FROM storage.buckets WHERE name = 'medicacoes_ubs';

-- Testar fun√ß√£o de login (substitua pelos dados reais)
SELECT * FROM public.fn_login('admin@pereiro.ce.gov.br', 'admin123');

10. COMO MIGRAR PARA OUTRO PROJETO SUPABASE - PASSO A PASSO VISUAL
===============================================================================

Para conectar este sistema a outro projeto Supabase, siga estes passos:

A. CRIANDO UM NOVO PROJETO SUPABASE
-----------------------------------
1. Acesse https://supabase.com
2. Clique em "New project" ou "Start your project"
3. Escolha sua organiza√ß√£o
4. Preencha:
   - Name: "UBS Pereiro" (ou nome de sua escolha)
   - Database Password: crie uma senha forte (anote ela!)
   - Region: South America (S√£o Paulo) - mais pr√≥ximo do Brasil
5. Clique em "Create new project"
6. Aguarde alguns minutos para o projeto ser criado

B. ONDE ENCONTRAR AS CHAVES DO SUPABASE
----------------------------------------
Ap√≥s o projeto ser criado:

1. CHAVES DE API (Project API keys):
   - No painel lateral esquerdo, v√° em "Settings" (Configura√ß√µes) 
   - Clique em "API"
   - Voc√™ ver√° duas chaves importantes:
     
     üìã anon / public key (CHAVE P√öBLICA):
     [texto longo come√ßando com "eyJhbGciOiJIUzI1NiIs..."]
     
     üîí service_role key (CHAVE PRIVADA - CUIDADO!):
     [texto longo come√ßando com "eyJhbGciOiJIUzI1NiIs..."]

2. PROJECT URL:
   - Na mesma tela "Settings > API"
   - Procure por "Project URL"
   - Exemplo: https://xyzabc123.supabase.co

3. PROJECT ID:
   - √â a parte antes de ".supabase.co" na URL
   - Exemplo: se a URL √© https://xyzabc123.supabase.co
   - Ent√£o o ID √©: xyzabc123

C. EXECUTANDO OS SCRIPTS SQL NO SUPABASE
----------------------------------------
1. No painel lateral esquerdo do Supabase, clique em "SQL Editor"
2. Clique no bot√£o "New query" para criar uma nova consulta
3. Cole TODO o c√≥digo SQL das se√ß√µes 1-6 deste documento:
   
   üìù COPIE E COLE EXATAMENTE ASSIM:
   - Primeiro: Se√ß√£o 1 (Cria√ß√£o das tabelas) - Cole e clique "Run"
   - Segundo: Se√ß√£o 2 (Fun√ß√µes) - Cole e clique "Run" 
   - Terceiro: Se√ß√£o 3 (Pol√≠ticas RLS) - Cole e clique "Run"
   - Quarto: Se√ß√£o 4 (Storage) - Cole e clique "Run"
   - Quinto: Se√ß√£o 5 (Dados iniciais) - Cole e clique "Run"
   - Sexto: Se√ß√£o 6 (Configura√ß√µes) - Cole e clique "Run"

4. Se houver erros, leia a mensagem e tente novamente
5. Para verificar se deu certo, execute: 
   SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';

D. VERIFICANDO O STORAGE (BUCKET)
---------------------------------
1. No painel lateral, clique em "Storage"
2. Voc√™ deve ver o bucket "medicacoes_ubs" criado
3. Se n√£o aparecer, volte no SQL Editor e execute novamente a Se√ß√£o 4

E. ALTERANDO AS CONFIGURA√á√ïES NO SEU PROJETO
--------------------------------------------
Agora voc√™ precisa alterar 3 arquivos no seu c√≥digo:

1. üìÑ Arquivo .env (na raiz do projeto):
   Substitua pelos novos valores:
   VITE_SUPABASE_PROJECT_ID="[seu-novo-project-id]"
   VITE_SUPABASE_PUBLISHABLE_KEY="[sua-nova-anon-key]"
   VITE_SUPABASE_URL="https://[seu-novo-project-id].supabase.co"

2. üìÑ Arquivo supabase/config.toml:
   Substitua:
   project_id = "[seu-novo-project-id]"

3. üìÑ Arquivo src/integrations/supabase/client.ts:
   Substitua:
   const SUPABASE_URL = "https://[seu-novo-project-id].supabase.co";
   const SUPABASE_PUBLISHABLE_KEY = "[sua-nova-anon-key]";

‚ö†Ô∏è IMPORTANTE: 
- [seu-novo-project-id] = pegue da URL do seu projeto
- [sua-nova-anon-key] = pegue da p√°gina Settings > API (anon key)

F. TESTANDO SE FUNCIONOU
-----------------------
1. Reinicie seu servidor local (Ctrl+C e npm run dev novamente)
2. Tente fazer login com:
   üìß Email: admin@pereiro.ce.gov.br
   üîí Senha: admin123
3. Se conseguir entrar, tudo funcionou!

G. ONDE VER OS DADOS NO SUPABASE
---------------------------------
1. Clique em "Table Editor" no painel lateral
2. Voc√™ ver√° as tabelas: usuarios, postos, usuario_posto, arquivos_pdf
3. Clique em cada uma para ver os dados
4. Para ver logs de erro, v√° em "Logs" no painel lateral

H. PROBLEMAS COMUNS E SOLU√á√ïES
------------------------------
‚ùå "Failed to fetch" ou erro de conex√£o:
   ‚úÖ Verifique se as URLs e chaves est√£o corretas nos 3 arquivos

‚ùå "relation does not exist":
   ‚úÖ Execute novamente os scripts SQL da Se√ß√£o 1

‚ùå Login n√£o funciona:
   ‚úÖ Verifique se executou a Se√ß√£o 2 (fun√ß√µes) e Se√ß√£o 5 (dados iniciais)

‚ùå Upload de PDF n√£o funciona:
   ‚úÖ Verifique se o bucket foi criado (Storage) e execute a Se√ß√£o 4

‚ùå "Row Level Security policy violation":
   ‚úÖ Execute novamente a Se√ß√£o 3 (Pol√≠ticas RLS)

IMPORTANTE:
- Sempre teste em ambiente de desenvolvimento antes de alterar produ√ß√£o
- Mantenha backups dos dados importantes
- As chaves Service Role devem ser mantidas em segredo
- Considere usar vari√°veis de ambiente para as configura√ß√µes sens√≠veis

==========================================================================
FIM DA CONFIGURA√á√ÉO - SISTEMA UBS PEREIRO
==========================================================================

üìã RESUMO R√ÅPIDO - ONDE ENCONTRAR CADA COISA NO SUPABASE:

üîß CONFIGURA√á√ïES E CHAVES:
   Settings > API = Ver chaves (anon key, service role key, project URL)

üíæ EXECUTAR C√ìDIGOS SQL:
   SQL Editor > New Query = Cole os c√≥digos SQL deste documento

üìä VER DADOS:
   Table Editor = Ver tabelas e dados (usuarios, postos, etc)

üìÅ VER ARQUIVOS:
   Storage > medicacoes_ubs = Ver PDFs enviados

üë• VER USU√ÅRIOS (se usar auth):
   Authentication > Users = Ver usu√°rios cadastrados

üìà VER LOGS E ERROS:
   Logs = Ver erros do sistema

üåê CONFIGURAR DOM√çNIO:
   Settings > General = Configurar URL personalizada

üîí POL√çTICAS DE SEGURAN√áA:
   Authentication > Policies = Ver pol√≠ticas RLS

==========================================================================